<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ç« è¯¦æƒ… - æˆ‘çš„å°ä¸–ç•Œ</title>
    <link rel="stylesheet" href="/pages/pages.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div class="music-player">
        <audio id="bgMusic" loop preload="auto" volume="0.5" autoplay>
            <source src="../src/uploads/bgm.mp3" type="audio/mp3">
        </audio>
        <button id="musicToggle" class="music-btn" title="æ’­æ”¾/æš‚åœèƒŒæ™¯éŸ³ä¹">
            <i class="fas fa-music"></i>
        </button>
        <div class="music-status" id="musicStatus">ğŸµ ç‚¹å‡»æ’­æ”¾éŸ³ä¹</div>
    </div>

    <!-- æ¨±èŠ±å®¹å™¨ -->
    <div class="sakura-container">
        <canvas id="sakura-canvas"></canvas>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="top-nav">
        <div class="nav-container">
            <button onclick="goBack()" class="back-btn">
                <i class="fas fa-arrow-left"></i> è¿”å›
            </button>
            <div class="nav-title">æ–‡ç« è¯¦æƒ…</div>
            <button onclick="goHome()" class="home-btn">
                <i class="fas fa-home"></i> é¦–é¡µ
            </button>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹ -->
    <main class="main-content">
        <article class="article-detail">
            <!-- æ–‡ç« å¤´éƒ¨ -->
            <header class="article-header">
                <div class="article-title-wrapper">
                    <h1 id="articleTitle">æ–‡ç« æ ‡é¢˜</h1>
                    <div class="title-decoration"></div>
                </div>
                
                <div class="article-meta">
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span id="articleDate">2024-01-01</span>
                    </div>
                    <div class="meta-divider">Â·</div>
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span id="readTime">3åˆ†é’Ÿé˜…è¯»</span>
                    </div>
                    <div class="meta-divider">Â·</div>
                    <div class="meta-item">
                        <i class="fas fa-tag"></i>
                        <span id="articleCategory">ä¸ªäººæ„Ÿæ‚Ÿ</span>
                    </div>
                </div>
            </header>

            <!-- æ–‡ç« å›¾ç‰‡ -->
            <div class="article-image" id="articleImageContainer" style="display: none;">
                <img id="articleImage" src="" alt="æ–‡ç« é…å›¾">
            </div>

            <!-- æ–‡ç« æ‘˜è¦ -->
            <div class="article-excerpt">
                <div class="excerpt-icon">
                    <i class="fas fa-quote-left"></i>
                </div>
                <p id="articleExcerpt">æ–‡ç« æ‘˜è¦...</p>
            </div>

            <!-- æ–‡ç« å†…å®¹ -->
            <div class="article-content">
                <div class="content-wrapper">
                    <div id="articleContent">
                        <p>æ–‡ç« å†…å®¹åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>

            <!-- æ–‡ç« åº•éƒ¨ -->
            <footer class="article-footer">
                <div class="article-tags" id="articleTags">
                    <!-- åŠ¨æ€åŠ è½½æ ‡ç­¾ -->
                </div>
                
                <div class="article-actions">
                    <button class="action-btn share-btn" onclick="shareArticle()">
                        <i class="fas fa-share"></i>
                        <span>åˆ†äº«æ–‡ç« </span>
                    </button>
                    <button class="action-btn like-btn" onclick="likeArticle()">
                        <i class="fas fa-heart"></i>
                        <span id="likeCount">0</span> å–œæ¬¢
                    </button>
                </div>
                
                <!-- æ–‡ç« ç»“æŸè£…é¥° -->
                <div class="article-end">
                    <div class="end-decoration">
                        <div class="end-line"></div>
                        <div class="end-symbol">âœ¿</div>
                        <div class="end-line"></div>
                    </div>
                    <p class="end-text">â€” å®Œ â€”</p>
                </div>
            </footer>
        </article>


    </main>

    <!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
    <button class="back-to-top" onclick="backToTop()">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨åŠ¨æ•ˆçŠ¶æ€
        let yellowFlowerEffects = {
            stars: null,
            particles: null,
            cursorGlow: null,
            isActive: false
        };

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadArticleDetail();
            initScrollEffects();
            loadThemeSettings();
            
            // ç›‘å¬ä¸»é¢˜å˜åŒ–
            initThemeChangeListener();

            // éŸ³ä¹æ— ç¼è¡”æ¥é€»è¾‘
            saveMusicState();
            restoreMusicState();

            // ç”¨æˆ·ç‚¹å‡»éŸ³ä¹æŒ‰é’®æ—¶ä¹Ÿå°è¯•æ¢å¤è¿›åº¦
            const musicBtn = document.getElementById('musicToggle');
            if (musicBtn) {
                musicBtn.addEventListener('click', restoreMusicState);
            }
        });

        // åŠ è½½ä¸»é¢˜è®¾ç½®
        async function loadThemeSettings() {
            try {
                const response = await fetch('/api/content');
                const data = await response.json();
                
                if (data && data.settings && data.settings.appearance && data.settings.appearance.theme) {
                    const theme = data.settings.appearance.theme;
                    applyTheme(theme);
                }
            } catch (error) {
                console.error('åŠ è½½ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
                // é»˜è®¤ä½¿ç”¨æ¨±èŠ±æ•ˆæœ
                initSakuraEffect();
            }
        }

        // åˆå§‹åŒ–ä¸»é¢˜å˜åŒ–ç›‘å¬å™¨
        function initThemeChangeListener() {
            let lastTheme = null;
            
            // å®šæœŸæ£€æŸ¥ä¸»é¢˜å˜åŒ–
            setInterval(async () => {
                try {
                    const response = await fetch('/api/content');
                    const data = await response.json();
                    
                    if (data && data.settings && data.settings.appearance && data.settings.appearance.theme) {
                        const currentTheme = data.settings.appearance.theme;
                        
                        // æ£€æŸ¥ä¸»é¢˜æ˜¯å¦å‘ç”Ÿå˜åŒ–
                        if (!lastTheme || lastTheme.name !== currentTheme.name) {
                            console.log(`è¯¦æƒ…é¡µæ£€æµ‹åˆ°ä¸»é¢˜å˜åŒ–: ${currentTheme.name}`);
                            lastTheme = currentTheme;
                            applyTheme(currentTheme);
                        }
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ä¸»é¢˜å˜åŒ–å¤±è´¥:', error);
                }
            }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        // åº”ç”¨ä¸»é¢˜
        function applyTheme(theme) {
            if (theme && theme.name) {
                document.documentElement.setAttribute('data-theme', theme.name);
                console.log(`è¯¦æƒ…é¡µå·²åº”ç”¨ä¸»é¢˜: ${theme.name}`);
                
                // ç§»é™¤æ‰€æœ‰åŠ¨æ•ˆ
                if (yellowFlowerEffects.isActive) {
                    removeYellowFlowerEffects();
                }
                // éšè—æ¨±èŠ±å®¹å™¨
                const sakuraContainer = document.querySelector('.sakura-container');
                if (sakuraContainer) {
                    sakuraContainer.style.display = 'none';
                }
                // ç§»é™¤é›ªèŠ±/æ˜Ÿæ˜Ÿå®¹å™¨ï¼ˆå…¨éƒ¨å¼ºåˆ¶æ¸…ç†ï¼Œé¿å…æ®‹ç•™ï¼‰
                const snowContainer = document.getElementById('white-snowflakes');
                if (snowContainer) snowContainer.remove();
                const starContainer = document.getElementById('yellow-stars-flat');
                if (starContainer) starContainer.remove();
                // åªä¿ç•™é»„è‰²èŠ±æœµå’Œé»‘è‰²æ¨±èŠ±ä¸»é¢˜çš„åŠ¨æ•ˆï¼Œæ˜äº®ä¸»é¢˜ä¸é£˜è½ä»»ä½•å…ƒç´ 
                if (theme.name === 'é»„è‰²èŠ±æœµ') {
                    createYellowStarsFlat();
                } else if (theme.name === 'é»‘è‰²æ¨±èŠ±') {
                    if (sakuraContainer) sakuraContainer.style.display = 'block';
                    initSakuraEffect();
                }
            }
        }

        // åˆå§‹åŒ–é»„è‰²èŠ±æœµä¸»é¢˜åŠ¨æ•ˆ
        function initYellowFlowerEffects() {
            if (yellowFlowerEffects.isActive) return;
            
            console.log('è¯¦æƒ…é¡µåˆå§‹åŒ–é»„è‰²èŠ±æœµä¸»é¢˜åŠ¨æ•ˆ');
            yellowFlowerEffects.isActive = true;
            
            // åˆ›å»ºæ˜Ÿæ˜ŸèƒŒæ™¯
            createYellowStars();
            
            // åˆ›å»ºç²’å­æ•ˆæœ
            createYellowParticles();
            
            // åˆ›å»ºèŠ±ç“£é£˜è½æ•ˆæœ
            createYellowPetals();
            
            // åˆ›å»ºé¼ æ ‡è·Ÿéšå…‰åœˆ
            createCursorGlow();
        }

        // ç§»é™¤é»„è‰²èŠ±æœµä¸»é¢˜åŠ¨æ•ˆ
        function removeYellowFlowerEffects() {
            if (!yellowFlowerEffects.isActive) return;
            
            console.log('è¯¦æƒ…é¡µç§»é™¤é»„è‰²èŠ±æœµä¸»é¢˜åŠ¨æ•ˆ');
            yellowFlowerEffects.isActive = false;
            
            // ç§»é™¤æ˜Ÿæ˜Ÿ
            if (yellowFlowerEffects.stars) {
                yellowFlowerEffects.stars.remove();
                yellowFlowerEffects.stars = null;
            }
            
            // ç§»é™¤ç²’å­
            if (yellowFlowerEffects.particles) {
                yellowFlowerEffects.particles.remove();
                yellowFlowerEffects.particles = null;
            }
            
            // ç§»é™¤èŠ±ç“£
            if (yellowFlowerEffects.petals) {
                yellowFlowerEffects.petals.remove();
                yellowFlowerEffects.petals = null;
            }
            
            // ç§»é™¤é¼ æ ‡å…‰åœˆ
            if (yellowFlowerEffects.cursorGlow) {
                yellowFlowerEffects.cursorGlow.remove();
                yellowFlowerEffects.cursorGlow = null;
            }
        }

        // åˆ›å»ºé»„è‰²æ˜Ÿæ˜ŸèƒŒæ™¯
        function createYellowStars() {
            const starsContainer = document.createElement('div');
            starsContainer.id = 'yellow-stars';
            starsContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
                background-image: 
                    radial-gradient(circle at 15% 25%, #f4d03f 2px, transparent 2px),
                    radial-gradient(circle at 85% 15%, #f7dc6f 1.5px, transparent 1.5px),
                    radial-gradient(circle at 25% 60%, #f4d03f 2.5px, transparent 2.5px),
                    radial-gradient(circle at 75% 80%, #f7dc6f 2px, transparent 2px),
                    radial-gradient(circle at 40% 35%, #f4d03f 1px, transparent 1px),
                    radial-gradient(circle at 90% 45%, #f7dc6f 2px, transparent 2px);
                background-size: 
                    200px 200px, 150px 150px, 180px 180px, 220px 220px, 120px 120px, 160px 160px;
                background-position: 
                    0 0, 50px 30px, 100px 80px, 150px 120px, 200px 20px, 30px 150px;
                background-attachment: fixed;
            `;
            
            document.body.appendChild(starsContainer);
            yellowFlowerEffects.stars = starsContainer;
            
            // æ·»åŠ åŠ¨æ€æ˜Ÿæ˜Ÿ
            for (let i = 0; i < 20; i++) {
                const star = document.createElement('div');
                star.className = 'yellow-star';
                star.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 4 + 2}px;
                    height: ${Math.random() * 4 + 2}px;
                    background: #f4d03f;
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: star-twinkle ${Math.random() * 3 + 2}s infinite ease-in-out;
                    animation-delay: ${Math.random() * 2}s;
                `;
                starsContainer.appendChild(star);
            }
        }

        // åˆ›å»ºé»„è‰²ç²’å­æ•ˆæœ
        function createYellowParticles() {
            const particlesContainer = document.createElement('div');
            particlesContainer.id = 'yellow-particles';
            particlesContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 2;
            `;
            
            document.body.appendChild(particlesContainer);
            yellowFlowerEffects.particles = particlesContainer;
            
            // åˆ›å»ºç²’å­
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'yellow-particle';
                particle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 3 + 1}px;
                    height: ${Math.random() * 3 + 1}px;
                    background: #f7dc6f;
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: particle-float ${Math.random() * 4 + 3}s infinite linear;
                    animation-delay: ${Math.random() * 2}s;
                    opacity: ${Math.random() * 0.6 + 0.4};
                `;
                particlesContainer.appendChild(particle);
            }
        }

        // åˆ›å»ºé»„è‰²æ˜Ÿæ˜Ÿé£˜è½æ•ˆæœ
        function createYellowPetals() {
            const starsContainer = document.createElement('div');
            starsContainer.id = 'yellow-stars-falling';
            starsContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 3;
            `;
            
            document.body.appendChild(starsContainer);
            yellowFlowerEffects.petals = starsContainer;
            
            // åˆ›å»ºæ˜Ÿæ˜Ÿ
            for (let i = 0; i < 25; i++) {
                const star = document.createElement('div');
                star.className = 'yellow-star-falling';
                
                // éšæœºæ˜Ÿæ˜Ÿå¤§å°å’Œç±»å‹
                const size = Math.random() * 20 + 8;
                const starType = Math.floor(Math.random() * 3); // 0-2 ä¸‰ç§æ˜Ÿæ˜Ÿç±»å‹
                
                let starStyle = '';
                if (starType === 0) {
                    // äº”è§’æ˜Ÿ
                    starStyle = `
                        width: ${size}px;
                        height: ${size}px;
                        background: radial-gradient(circle at 30% 30%, #fef9e7 0%, #f7dc6f 40%, #f4d03f 70%, #f39c12 100%);
                        clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                        box-shadow: 
                            inset 1px 1px 2px rgba(255, 255, 255, 0.6),
                            inset -1px -1px 2px rgba(0, 0, 0, 0.2),
                            0 0 10px rgba(244, 208, 63, 0.8),
                            0 0 20px rgba(244, 208, 63, 0.4);
                        border: 1px solid rgba(244, 208, 63, 0.8);
                    `;
                } else if (starType === 1) {
                    // å…­è§’æ˜Ÿ
                    starStyle = `
                        width: ${size}px;
                        height: ${size}px;
                        background: radial-gradient(circle at 40% 40%, #fef9e7 0%, #f7dc6f 50%, #f4d03f 80%, #f39c12 100%);
                        clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
                        box-shadow: 
                            inset 1px 1px 2px rgba(255, 255, 255, 0.6),
                            inset -1px -1px 2px rgba(0, 0, 0, 0.2),
                            0 0 10px rgba(244, 208, 63, 0.8),
                            0 0 20px rgba(244, 208, 63, 0.4);
                        border: 1px solid rgba(244, 208, 63, 0.8);
                    `;
                } else {
                    // è±å½¢æ˜Ÿ
                    starStyle = `
                        width: ${size}px;
                        height: ${size}px;
                        background: radial-gradient(circle at 35% 35%, #fef9e7 0%, #f7dc6f 45%, #f4d03f 75%, #f39c12 100%);
                        clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
                        box-shadow: 
                            inset 1px 1px 2px rgba(255, 255, 255, 0.6),
                            inset -1px -1px 2px rgba(0, 0, 0, 0.2),
                            0 0 10px rgba(244, 208, 63, 0.8),
                            0 0 20px rgba(244, 208, 63, 0.4);
                        border: 1px solid rgba(244, 208, 63, 0.8);
                    `;
                }
                
                star.style.cssText = `
                    position: absolute;
                    ${starStyle}
                    left: ${Math.random() * 120 - 10}%;
                    top: -40px;
                    animation: star-fall-${starType} ${Math.random() * 12 + 10}s linear infinite;
                    animation-delay: ${Math.random() * 8}s;
                    opacity: ${Math.random() * 0.8 + 0.2};
                    transform: rotate(${Math.random() * 360}deg);
                    filter: brightness(${Math.random() * 0.4 + 0.8}) drop-shadow(0 0 5px rgba(244, 208, 63, 0.6));
                `;
                starsContainer.appendChild(star);
            }
        }

        // åˆ›å»ºé¼ æ ‡è·Ÿéšå…‰åœˆ
        function createCursorGlow() {
            // è§¦æ‘¸è®¾å¤‡ä¸æ˜¾ç¤ºé¼ æ ‡è·Ÿéšæ•ˆæœ
            if ('ontouchstart' in window) {
                return;
            }
            
            const cursorGlow = document.createElement('div');
            cursorGlow.className = 'cursor-glow';
            cursorGlow.style.cssText = `
                position: fixed;
                width: 40px;
                height: 40px;
                background: radial-gradient(circle, rgba(244, 208, 63, 0.3) 0%, transparent 70%);
                border-radius: 50%;
                pointer-events: none;
                z-index: 9999;
                transition: all 0.1s ease;
                mix-blend-mode: screen;
            `;
            
            document.body.appendChild(cursorGlow);
            yellowFlowerEffects.cursorGlow = cursorGlow;
            
            // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
            document.addEventListener('mousemove', function(e) {
                cursorGlow.style.left = e.clientX - 20 + 'px';
                cursorGlow.style.top = e.clientY - 20 + 'px';
            });
            
            // æ‚¬åœæ•ˆæœ
            const hoverElements = document.querySelectorAll('.action-btn, button, a');
            hoverElements.forEach(element => {
                element.addEventListener('mouseenter', function() {
                    cursorGlow.style.transform = 'scale(1.5)';
                    cursorGlow.style.background = 'radial-gradient(circle, rgba(244, 208, 63, 0.5) 0%, transparent 70%)';
                });
                element.addEventListener('mouseleave', function() {
                    cursorGlow.style.transform = 'scale(1)';
                    cursorGlow.style.background = 'radial-gradient(circle, rgba(244, 208, 63, 0.3) 0%, transparent 70%)';
                });
            });
        }

        // åŠ è½½æ–‡ç« è¯¦æƒ…
        async function loadArticleDetail() {
            try {
                // ä»URLå‚æ•°è·å–ç±»å‹å’ŒID
                const urlParams = new URLSearchParams(window.location.search);
                const contentType = urlParams.get('type') || 'articles';
                const contentId = urlParams.get('id') || 1;

                // è·å–å†…å®¹æ•°æ®
                const response = await fetch(`/api/data/${contentType}/${contentId}`);
                if (!response.ok) {
                    throw new Error('å†…å®¹ä¸å­˜åœ¨');
                }
                
                const article = await response.json();
                
                // å¡«å……å†…å®¹
                document.getElementById('articleTitle').textContent = article.title;
                document.getElementById('articleDate').textContent = formatDate(article.date);
                document.getElementById('articleExcerpt').textContent = article.excerpt || article.description || 'æš‚æ— æ‘˜è¦';
                document.getElementById('articleContent').innerHTML = formatContent(article.content);
                
                // è®¾ç½®é¡µé¢æ ‡é¢˜
                document.title = `${article.title} - æˆ‘çš„å°ä¸–ç•Œ`;
                
                // æ˜¾ç¤ºå›¾ç‰‡
                if (article.image) {
                    const imageContainer = document.getElementById('articleImageContainer');
                    const image = document.getElementById('articleImage');
                    
                    // æ ‡å‡†åŒ–å›¾ç‰‡è·¯å¾„å‡½æ•°
                    function normalizeImagePath(path) {
                        if (!path) return '';
                        if (path.startsWith('http://') || path.startsWith('https://')) {
                            return path;
                        }
                        if (path.startsWith('/')) {
                            return path;
                        }
                        return '/' + path;
                    }
                    
                    const imagePath = normalizeImagePath(article.image);
                    
                    // æ·»åŠ å›¾ç‰‡åŠ è½½äº‹ä»¶ç›‘å¬
                    image.onload = function() {
                        imageContainer.style.display = 'block';
                        console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ:', imagePath);
                    };
                    
                    image.onerror = function() {
                        console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', imagePath);
                        // å°è¯•å…¶ä»–å¯èƒ½çš„è·¯å¾„
                        const fallbackPaths = [
                            article.image,  // åŸå§‹è·¯å¾„
                            'src/uploads/' + article.image.split('/').pop(),  // åªå–æ–‡ä»¶å
                            '/src/uploads/' + article.image.split('/').pop() // æ·»åŠ å‰ç¼€
                        ];
                        
                        let currentIndex = 0;
                        const tryNextPath = () => {
                            currentIndex++;
                            if (currentIndex < fallbackPaths.length) {
                                const fallbackPath = normalizeImagePath(fallbackPaths[currentIndex]);
                                console.log('å°è¯•å¤‡ç”¨è·¯å¾„:', fallbackPath);
                                image.onerror = tryNextPath;
                                image.src = fallbackPath;
                            } else {
                                console.error('æ‰€æœ‰è·¯å¾„éƒ½åŠ è½½å¤±è´¥ï¼Œéšè—å›¾ç‰‡å®¹å™¨');
                                imageContainer.style.display = 'none';
                            }
                        };
                        
                        tryNextPath();
                    };
                    
                    image.src = imagePath;
                    image.alt = article.title;
                }
                
                // æ˜¾ç¤ºæ ‡ç­¾
                displayTags(article.tags);
                
                // è®¡ç®—é˜…è¯»æ—¶é—´
                const readTime = Math.max(Math.ceil(article.content.length / 200), 1);
                document.getElementById('readTime').textContent = `${readTime}åˆ†é’Ÿé˜…è¯»`;
                
                // æ¸²æŸ“æ–‡ç« å†…å®¹åä¿®æ­£aæ ‡ç­¾hrefï¼Œç¡®ä¿å¤–é“¾è·³è½¬æ­£ç¡®
                fixArticleLinks();
            } catch (error) {
                console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                document.getElementById('articleTitle').textContent = 'æ–‡ç« ä¸å­˜åœ¨';
                document.getElementById('articleContent').innerHTML = '<p>æŠ±æ­‰ï¼Œæ‚¨è¦æŸ¥çœ‹çš„æ–‡ç« ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ã€‚</p>';
            }
        }

        // æ˜¾ç¤ºæ ‡ç­¾
        function displayTags(tags) {
            const tagsContainer = document.getElementById('articleTags');
            if (!tagsContainer) return;
            
            if (tags && tags.length > 0) {
                tagsContainer.innerHTML = tags.map(tag => 
                    `<span class="tag">${tag}</span>`
                ).join('');
            } else {
                tagsContainer.innerHTML = '';
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            if (!dateString) return 'æœªçŸ¥æ—¥æœŸ';
            
            // å¤„ç†ä¸åŒçš„æ—¥æœŸæ ¼å¼
            try {
                // å¤„ç† "YYYY-MM-DD" æ ¼å¼
                if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateString)) {
                    const date = new Date(dateString);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                }
                
                // å¤„ç† "YYYYå¹´MMæœˆ" æ ¼å¼
                if (/^\d{4}å¹´\d{1,2}æœˆ$/.test(dateString)) {
                    return dateString;
                }
                
                // å¤„ç†å¹´ä»½èŒƒå›´æ ¼å¼ "YYYY-YYYY" æˆ– "YYYY-è‡³ä»Š"
                if (/^\d{4}-/.test(dateString)) {
                    return dateString;
                }
                
                // å¤„ç†å…¶ä»–æ ¼å¼ï¼Œç›´æ¥æ˜¾ç¤ºåŸæ–‡
                return dateString;
                
            } catch (error) {
                console.error('æ—¥æœŸè§£æé”™è¯¯:', error);
                return dateString || 'æœªçŸ¥æ—¥æœŸ';
            }
        }

        // æ ¼å¼åŒ–æ–‡ç« å†…å®¹
        function formatContent(content) {
            if (!content) return '<p>æš‚æ— å†…å®¹</p>';
            
            // å¦‚æœå†…å®¹å·²ç»åŒ…å«HTMLæ ‡ç­¾ï¼Œç›´æ¥è¿”å›
            if (content.includes('<') && content.includes('>')) {
                return content;
            }
            
            // å¯¹äºçº¯æ–‡æœ¬å†…å®¹ï¼Œè¿›è¡Œæ®µè½æ ¼å¼åŒ–
            return content
                .replace(/\n\n+/g, '</p><p>') // å¤šä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸ºæ®µè½
                .replace(/\n/g, '<br>') // å•ä¸ªæ¢è¡Œç¬¦è½¬æ¢ä¸ºæ¢è¡Œ
                .replace(/^/, '<p>') // å¼€å¤´æ·»åŠ æ®µè½æ ‡ç­¾
                .replace(/$/, '</p>') // ç»“å°¾æ·»åŠ æ®µè½æ ‡ç­¾
                .replace(/<p><\/p>/g, ''); // ç§»é™¤ç©ºæ®µè½
        }

        // è¿”å›ä¸Šä¸€é¡µ
        function goBack() {
            if (window.history.length > 1) {
                window.history.back();
            } else {
                goHome();
            }
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            window.location.href = '/';
        }

        // åˆ†äº«æ–‡ç« 
        function shareArticle() {
            if (navigator.share) {
                navigator.share({
                    title: document.getElementById('articleTitle').textContent,
                    text: document.getElementById('articleExcerpt').textContent,
                    url: window.location.href
                });
            } else {
                // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(window.location.href).then(() => {
                    alert('æ–‡ç« é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                });
            }
        }

        // ç‚¹èµæ–‡ç« 
        function likeArticle() {
            const likeBtn = event.target.closest('.action-btn');
            const icon = likeBtn.querySelector('i');
            const countSpan = document.getElementById('likeCount');
            
            if (icon.classList.contains('fas')) {
                icon.classList.remove('fas');
                icon.classList.add('far');
                countSpan.textContent = Math.max(parseInt(countSpan.textContent) - 1, 0);
            } else {
                icon.classList.remove('far');
                icon.classList.add('fas');
                countSpan.textContent = parseInt(countSpan.textContent) + 1;
            }
        }

        // è¿”å›é¡¶éƒ¨
        function backToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // åˆå§‹åŒ–æ»šåŠ¨æ•ˆæœ
        function initScrollEffects() {
            const backToTopBtn = document.querySelector('.back-to-top');
            
            window.addEventListener('scroll', function() {
                if (window.scrollY > 300) {
                    backToTopBtn.style.opacity = '1';
                    backToTopBtn.style.visibility = 'visible';
                } else {
                    backToTopBtn.style.opacity = '0';
                    backToTopBtn.style.visibility = 'hidden';
                }
            });
        }

        // åˆ›å»ºé»„è‰²äº”è§’æ˜Ÿé£˜è½æ•ˆæœ
        function createYellowStarsFlat() {
            const starsContainer = document.createElement('div');
            starsContainer.id = 'yellow-stars-flat';
            starsContainer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                pointer-events: none;
                z-index: 3;
            `;
            document.body.appendChild(starsContainer);
            yellowFlowerEffects.petals = starsContainer;
            // ç”Ÿæˆ5~8é¢—äº”è§’æ˜Ÿï¼Œåˆ†å¸ƒåœ¨å·¦å³ä¸¤ä¾§
            const count = Math.floor(Math.random() * 4) + 5; // 5~8é¢—
            for (let i = 0; i < count; i++) {
                const star = document.createElement('div');
                star.className = 'yellow-star-flat';
                const size = Math.random() * 24 + 12;
                // å·¦å³ä¸¤ä¾§åˆ†å¸ƒ
                const left = (i % 2 === 0)
                    ? (Math.random() * 8 + 2) // 2vw~10vw
                    : (Math.random() * 8 + 90); // 90vw~98vw
                const duration = (Math.random() * 4 + 6) * 2; // åŠ¨ç”»æ—¶é•¿åŠ å€
                const delay = Math.random() * 4;
                star.style.cssText = `
                    position: absolute;
                    left: ${left}vw;
                    top: -40px;
                    width: ${size}px;
                    height: ${size}px;
                    background: #FFD600;
                    clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
                    opacity: 1;
                    animation: star-flat-fall ${duration}s linear ${delay}s infinite;
                `;
                starsContainer.appendChild(star);
            }
        }

        // æ¨±èŠ±æ•ˆæœ
        function initSakuraEffect() {
            const canvas = document.getElementById('sakura-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let sakuras = [];
            
            // è°ƒæ•´canvaså°ºå¯¸
            function resizeCanvas() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // æ¨±èŠ±ç±»
            class Sakura {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = -20;
                    this.speed = Math.random() * 2 + 1;
                    this.opacity = Math.random() * 0.6 + 0.2;
                    this.size = Math.random() * 6 + 4;
                    this.rotation = 0;
                    this.rotationSpeed = (Math.random() - 0.5) * 0.1;
                    this.swaySpeed = Math.random() * 0.02 + 0.01;
                    this.swayAmount = Math.random() * 50 + 20;
                }
                
                update() {
                    this.y += this.speed;
                    this.rotation += this.rotationSpeed;
                    this.x += Math.sin(this.y * this.swaySpeed) * 0.5;
                    
                    if (this.y > canvas.height + 20) {
                        this.y = -20;
                        this.x = Math.random() * canvas.width;
                    }
                }
                
                draw() {
                    ctx.save();
                    ctx.globalAlpha = this.opacity;
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation);
                    
                    // ç»˜åˆ¶æ¨±èŠ±èŠ±ç“£
                    const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, this.size);
                    gradient.addColorStop(0, '#ffb3d9');
                    gradient.addColorStop(0.5, '#ff8fab');
                    gradient.addColorStop(1, '#ff6b9d');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    for (let i = 0; i < 5; i++) {
                        const angle = (i * Math.PI * 2) / 5;
                        const x = Math.cos(angle) * this.size;
                        const y = Math.sin(angle) * this.size;
                        if (i === 0) {
                            ctx.moveTo(x, y);
                        } else {
                            ctx.lineTo(x, y);
                        }
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            }
            
            // åˆ›å»ºæ¨±èŠ±
            for (let i = 0; i < 30; i++) {
                sakuras.push(new Sakura());
            }
            
            // åŠ¨ç”»å¾ªç¯
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                sakuras.forEach(sakura => {
                    sakura.update();
                    sakura.draw();
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // éŸ³ä¹æ— ç¼è¡”æ¥é€»è¾‘
        function saveMusicState() {
            const audio = document.getElementById('bgMusic');
            if (audio) {
                localStorage.setItem('music-currentTime', audio.currentTime);
                localStorage.setItem('music-paused', audio.paused);
            }
        }
        function restoreMusicState() {
            const audio = document.getElementById('bgMusic');
            if (audio) {
                const time = parseFloat(localStorage.getItem('music-currentTime') || '0');
                const paused = localStorage.getItem('music-paused') === 'true';
                audio.oncanplay = function() {
                    audio.currentTime = time;
                    if (!paused) {
                        audio.play().catch(() => {
                            // è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªï¼Œå°è¯•é™éŸ³æ’­æ”¾å†æ¢å¤
                            setTimeout(() => {
                                audio.muted = true;
                                audio.play().then(() => {
                                    audio.muted = false;
                                });
                            }, 200);
                        });
                    } else {
                        audio.pause();
                    }
                };
            }
        }
        window.addEventListener('beforeunload', saveMusicState);
        window.addEventListener('DOMContentLoaded', restoreMusicState);

        // æ¸²æŸ“æ–‡ç« å†…å®¹åä¿®æ­£aæ ‡ç­¾hrefï¼Œç¡®ä¿å¤–é“¾è·³è½¬æ­£ç¡®
        function fixArticleLinks() {
            document.querySelectorAll('#articleContent a').forEach(a => {
                let href = a.getAttribute('href');
                if (href && !href.startsWith('http://') && !href.startsWith('https://')) {
                    href = 'https://' + href.replace(/^\/+/, '');
                    a.setAttribute('href', href);
                }
                a.setAttribute('target', '_blank');
                a.setAttribute('rel', 'noopener noreferrer');
            });
        }
    </script>
</body>
</html> 